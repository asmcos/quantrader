<!DOCTYPE html>
<!--use klinecharts 8.6.2 -->
<html style="height:100%;" >
    <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />

 <link href="https://klang.org.cn/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
     <!-- font awesome CSS -->
<link  href="https://lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
      <!-- Vendor CSS Files -->
   <style>
    .stock-chart {
        width: 100%;
        height: 100%;
        position: relative
    }

    .k-line-chart-dark {
        position: relative;
        height: 100%;
        background-color: #1e2126;
        transition: all .5s
    }

    .top-bar {
        font-size: 14px;
        height: 38px;
        color: #929aa5;
        border-bottom: 1px solid #393a3e;
        padding: 0 20px 0 12px
    }
    .tools {
        width: 48px;
        height: 100%;
        border-right: 1px solid #393a3e
    }
    .chart-widget {
        width: calc(100% - 65px);
        height: 100%;
        position: relative
    }

    .k-line-chart-light {
        position: relative;
        height: 100%;
        width: 100%;
        min-height:680px;
        margin:10px;
        background-color: #fff;
        transition: all .5s
    }

    .k-line-chart-container {
        height: calc(100% - 18px)
    }
    .bg {
        background: rgba(14, 22, 34, 0.02);
    }


   .boardmain {
        display: -webkit-box;
        display: -webkit-flex;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-flex-direction: column;
        flex-direction: column;
        -webkit-box-align: start;
        -webkit-align-items: flex-start;
        align-items: flex-start;
    }   

    .boardmain > div.three{
        -webkit-box-ordinal-group: 3;
        -moz-box-ordinal-group: 3;
        -ms-flex-order: 3;
        -webkit-order: 3;
        order: 3;
        overflow:visible;
    } 

    .boardmain > div.two{
        -webkit-box-ordinal-group: 2;
        -moz-box-ordinal-group: 2;
        -ms-flex-order: 2;
        -webkit-order: 2;
        order: 2;
        overflow:visible;
    }

    .boardmain > div.one{
        -webkit-box-ordinal-group: 1;
        -moz-box-ordinal-group: 1;
        -ms-flex-order: 1;
        -webkit-order: 1;
        order: 1;
    }   

    .chart-tools-bar {
    display: flex;
    flex-direction: column;
    align-items: center;
    box-sizing: border-box;
    height: 100%;
    width: 52px;
    border-right: 1px solid #ebedf1
}

[data-prefers-color=dark] .chart-tools-bar {
    border-right: 1px solid #292929
}

.chart-tools-bar .icon-wrapper {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    height: 36px;
    width: 36px;
    margin-top: 8px;
    cursor: pointer;
    border-radius: 4px
}

.chart-tools-bar .icon-wrapper:hover {
    background-color: rgba(22,119,255,.1)
}

[data-prefers-color=dark] .chart-tools-bar .icon-wrapper:hover {
    background-color: rgba(22,119,255,.1)
}

.chart-tools-bar .icon-wrapper svg {
    width: 36px;
    height: 36px;
    fill: #677294
}

[data-prefers-color=dark] .chart-tools-bar .icon-wrapper svg {
    fill: #929aa5
}


   </style>

 


    <title>Klang(金浪)自选股票</title>

    </head>
    <body class="bg" style="height: 100%;min-height:600px;">
     <div id="app" style="height:100%;opacity:0;">
        <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm" style="min-height:60px;">
        <div class="container-fluid">
            <a class="navbar-brand" href="https://www.klang.org.cn/online.html">公式选股</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="https://www.klang.org.cn">主页</a>
                </li>

            </ul>
            </div>
            </div>
        </nav>

  
      <div class="boardmain" style="height:100%;width:70%;float:left;" v-show="display_state=='1'">
      <div v-bind:class="'k-line-chart-light shadow-sm p-3 mb-5 bg-white rounded ' + lineorder">
          <div class="top-bar"> 
            <span style="margin-right:10px;">{{stockname}}:<a v-bind:href="'/kline.html?code='+stockcode" >{{stockcode}}</a></span>
            <span> 当前价格:{{curprice}}</span>
            <span v-if="curracapital !=0"> 流通市值:{{Number(curprice * curracapital).toFixed(2)}} 亿</span>
            <span v-if="totalcapital !=0"> 总市值:{{Number(curprice * totalcapital).toFixed(2)}} 亿</span>
            <span v-if="jinglirun !=0"> 净利润:{{Number(jinglirun).toFixed(2)}} 亿</span>
            <i class="fa fa-arrow-down"  v-if="lineorder=='one'" @click="linedown"></i>
            <i class="fa fa-arrow-up" v-if="lineorder=='three'" @click="lineup"></i>

          </div>

          <div class="row stock-chart k-line-chart-container"> 
              <div class="col tools"> </div>

              <div class="chart-widget">
                <div id="klinelinemain" style="width:100%;height:100%;"> </div>
              </div>
          </div>

      </div> <!-- k-line-chart-light -->

      <div class="k-line-chart-light shadow-sm p-3 mb-5 bg-white rounded two">
          <div class="top-bar"> 
            <span style="margin-right:10px;">{{stockname}}:<a v-bind:href="'/kline.html?code='+stockcode" >{{stockcode}}</a></span>
            <span> 当前价格:{{curprice}}</span>
            <span v-if="curracapital !=0"> 流通市值:{{Number(curprice * curracapital).toFixed(2)}} 亿</span>
            <span v-if="totalcapital !=0"> 总市值:{{Number(curprice * totalcapital).toFixed(2)}} 亿</span>
            <span v-if="jinglirun !=0"> 净利润:{{Number(jinglirun).toFixed(2)}} 亿</span>
          </div>

          <div class="row stock-chart k-line-chart-container"> 
              <div class="col tools"> 
        <div class="chart-tools-bar">
        <div class="icon-wrapper" @click="create_overlay('horizontalStraightLine')">
            <svg viewBox="0 0 24 24"><rect x="5" y="11.5" width="14" height="1" rx="0.5">

            </rect><ellipse cx="12" cy="12" rx="1.5" ry="1.5"></ellipse></svg>
        </div>
        <div class="icon-wrapper" @click="create_overlay('horizontalRayLine')">
            <svg viewBox="0 0 24 24"><rect x="4.5" y="11.5" width="15" height="1" rx="0.5"></rect>
                <ellipse cx="6" cy="12" rx="1.5" ry="1.5"></ellipse><ellipse cx="13" cy="12" rx="1.5" ry="1.5"></ellipse>
            </svg>
            </div>
        <div class="icon-wrapper" @click="create_overlay('horizontalSegment')">
            <svg viewBox="0 0 24 24"><rect x="5" y="11.5" width="14" height="1" rx="0.5"></rect>
                <ellipse cx="6" cy="12" rx="1.5" ry="1.5"></ellipse><ellipse cx="18" cy="12" rx="1.5" ry="1.5"></ellipse>
            </svg></div>
            
            
            <div class="icon-wrapper" @click="create_overlay('verticalStraightLine')" ><svg viewBox="0 0 24 24"><rect x="11.5" y="4" width="1" height="16" rx="0.5"></rect>
                <ellipse cx="12" cy="12" rx="1.5" ry="1.5"></ellipse></svg>
            </div>
            
            <div class="icon-wrapper" @click="create_overlay('verticalRayLine')"><svg viewBox="0 0 24 24">
                    <rect x="11.5" y="4.5" width="1" height="15" rx="0.5"></rect><ellipse cx="12" cy="18" rx="1.5" ry="1.5"></ellipse>
                    <ellipse cx="12" cy="11" rx="1.5" ry="1.5"></ellipse></svg>
                </div>
                
            <div class="icon-wrapper" @click="create_overlay('verticalSegment')"><svg viewBox="0 0 24 24"><rect x="11.5" y="5" width="1" height="14" rx="0.5"></rect><ellipse cx="12" cy="18" rx="1.5" ry="1.5"></ellipse><ellipse cx="12" cy="6" rx="1.5" ry="1.5"></ellipse></svg></div>
            <div class="icon-wrapper" @click="create_overlay('straightLine')"><svg viewBox="0 0 24 24"><rect x="5.989593505859375" y="17.303306579589844" width="16" height="1" rx="0.5" transform="matrix(0.7071067690849304,-0.7071067690849304,0.7071067690849304,0.7071067690849304,-10.480973816180722,9.303303481670355)"></rect><ellipse cx="14" cy="10" rx="1.5" ry="1.5"></ellipse><ellipse cx="10" cy="14" rx="1.5" ry="1.5"></ellipse></svg></div>
            <div class="icon-wrapper" @click="create_overlay('rayLine')"><svg viewBox="0 0 24 24"><rect x="6.989593505859375" y="16.303314208984375" width="15" height="1" rx="0.5" transform="matrix(0.7071067690849304,-0.7071067690849304,0.7071067690849304,0.7071067690849304,-9.480979210977239,9.71751925443823)"></rect><ellipse cx="13" cy="11" rx="1.5" ry="1.5"></ellipse><ellipse cx="8" cy="16" rx="1.5" ry="1.5"></ellipse></svg></div>
            <div class="icon-wrapper" @click="create_overlay('segment')"><svg viewBox="0 0 24 24"><rect x="5.989593505859375" y="17.303298950195312" width="14" height="1" rx="0.5" transform="matrix(0.7071067690849304,-0.7071067690849304,0.7071067690849304,0.7071067690849304,-10.480968421384205,9.30330124707234)"></rect><ellipse cx="16" cy="8" rx="1.5" ry="1.5"></ellipse><ellipse cx="7" cy="17" rx="1.5" ry="1.5"></ellipse></svg></div>
            <div class="icon-wrapper" @click="create_overlay('priceLine')"><svg viewBox="0 0 24 24"><rect x="4.5" y="13.5" width="15" height="1" rx="0.5"></rect><ellipse cx="6" cy="14" rx="1.5" ry="1.5"></ellipse>
                <path d="M8.314036947998046,12.235949340820312L10.985912947998047,12.235949340820312L10.985912947998047,11.517199340820312L10.151922947998047,11.517199340820312L10.151922947998047,7.735949340820312L9.497632947998047,7.735949340820312C9.214422947998047,7.917589340820312,8.915602947998046,8.030869340820313,8.464427947998047,8.108999340820313L8.464427947998047,8.661729340820312L9.274972947998046,8.661729340820312L9.274972947998046,11.517199340820312L8.314036947998046,11.517199340820312L8.314036947998046,12.235949340820312ZM11.581612947998046,12.235949340820312L14.556222947998048,12.235949340820312L14.556222947998048,11.493759340820311L13.597242947998048,11.493759340820311C13.386302947998047,11.493759340820311,13.093332947998046,11.517199340820312,12.864822947998046,11.546499340820311C13.675362947998046,10.724229340820312,14.347242947998048,9.831649340820313,14.347242947998048,9.001579340820312C14.347242947998048,8.151969340820312,13.788642947998046,7.610949340820312,12.948802947998047,7.610949340820312C12.343332947998046,7.610949340820312,11.946852947998046,7.845329340820312,11.532782947998047,8.290639340820313L12.024972947998048,8.778919340820313C12.247632947998046,8.525009340820313,12.511302947998047,8.308219340820312,12.835522947998047,8.308219340820312C13.261302947998047,8.308219340820312,13.501532947998047,8.593369340820313,13.501532947998047,9.044539340820313C13.501532947998047,9.757429340820313,12.792552947998047,10.618759340820311,11.581612947998046,11.726179340820313L11.581612947998046,12.235949340820312ZM16.460522947998047,12.360949340820312C17.312082947998046,12.360949340820312,18.026902947998046,11.894149340820313,18.026902947998046,11.048449340820312C18.026902947998046,10.431259340820311,17.642162947998045,10.050399340820313,17.144112947998046,9.911729340820312L17.144112947998046,9.882429340820313C17.612862947998046,9.696889340820313,17.882402947998045,9.331649340820313,17.882402947998045,8.823839340820312C17.882402947998045,8.032829340820312,17.300362947998046,7.610949340820312,16.44294294799805,7.610949340820312C15.921462947998046,7.610949340820312,15.495682947998047,7.821889340820313,15.110912947998047,8.151969340820312L15.565992947998048,8.722279340820313C15.825752947998048,8.460559340820312,16.083572947998046,8.308219340820312,16.401922947998045,8.308219340820312C16.77888294799805,8.308219340820312,16.99568294799805,8.525009340820313,16.99568294799805,8.892199340820312C16.99568294799805,9.319929340820313,16.730052947998047,9.610949340820312,15.921462947998046,9.610949340820312L15.921462947998046,10.247669340820313C16.88044294799805,10.247669340820313,17.138252947998048,10.530869340820313,17.138252947998048,10.991809340820312C17.138252947998048,11.407829340820314,16.833572947998046,11.642199340820312,16.38239294799805,11.642199340820312C15.974192947998047,11.642199340820312,15.657782947998047,11.433219340820312,15.392162947998047,11.161729340820312L14.978102947998046,11.743759340820311C15.290602947998046,12.097279340820313,15.765212947998048,12.360949340820312,16.460522947998047,12.360949340820312Z"></path></svg></div>
            <div class="icon-wrapper" @click="create_overlay('parallelStraightLine')"><svg viewBox="0 0 24 24"><rect x="7.989593505859375" y="20.303314208984375" width="16" height="1" rx="0.5" transform="matrix(0.7071067690849304,-0.7071067690849304,0.7071067690849304,0.7071067690849304,-12.016513056401891,11.596198947183439)"></rect><rect x="3.4586830139160156" y="15.292892456054688" width="16" height="1" rx="0.5" transform="matrix(0.7071067690849304,-0.7071067690849304,0.7071067690849304,0.7071067690849304,-9.800682931907204,6.924842852749634)"></rect><ellipse cx="16" cy="13" rx="1.5" ry="1.5"></ellipse><ellipse cx="12" cy="17" rx="1.5" ry="1.5"></ellipse><ellipse cx="9.5" cy="10" rx="1.5" ry="1.5"></ellipse></svg></div>
            <div class="icon-wrapper" @click="create_overlay('priceChannelLine')"><svg viewBox="0 0 24 24"><rect x="5.989593505859375" y="17.303298950195312" width="16" height="1" rx="0.5" transform="matrix(0.7071067690849304,-0.7071067690849304,0.7071067690849304,0.7071067690849304,-10.480968421384205,9.30330124707234)"></rect><rect x="5.031974792480469" y="13.607009887695312" width="12" height="1" rx="0.5" transform="matrix(0.7071067690849304,-0.7071067690849304,-0.7071067690849304,-0.7071067690849304,11.095440153447726,26.786762123917924)"></rect><rect x="11.40380859375" y="19.303298950195312" width="12" height="1" rx="0.5" transform="matrix(0.7071067690849304,-0.7071067690849304,-0.7071067690849304,-0.7071067690849304,16.98959169711361,41.016502553537975)"></rect><ellipse cx="14" cy="10" rx="1.5" ry="1.5"></ellipse><ellipse cx="10" cy="14" rx="1.5" ry="1.5"></ellipse><ellipse cx="15" cy="15" rx="1.5" ry="1.5"></ellipse></svg></div>
            <div class="icon-wrapper" @click="create_overlay('fibonacciLine')"><svg viewBox="0 0 24 24"><rect x="4" y="6" width="16" height="1" rx="0.5"></rect><rect x="4" y="9" width="16" height="1" rx="0.5"></rect><rect x="4" y="15" width="16" height="1" rx="0.5"></rect><rect x="4" y="18" width="16" height="1" rx="0.5"></rect><rect x="4" y="12" width="16" height="1" rx="0.5"></rect><ellipse cx="12" cy="18.5" rx="1.5" ry="1.5"></ellipse><ellipse cx="16" cy="6.5" rx="1.5" ry="1.5"></ellipse><ellipse cx="8" cy="6.5" rx="1.5" ry="1.5"></ellipse></svg></div>
            <div class="icon-wrapper" @click="remove_overlay()"><svg viewBox="0 0 1024 1024" style="width: 34px; height: 34px;">
                <path d="M256 333.872a28.8 28.8 0 0 1 28.8 28.8V768a56.528 56.528 0 0 0 56.544 56.528h341.328A56.528 56.528 0 0 0 739.2 768V362.672a28.8 28.8 0 0 1 57.6 0V768a114.128 114.128 0 0 1-114.128 114.128H341.328A114.128 114.128 0 0 1 227.2 768V362.672a28.8 28.8 0 0 1 28.8-28.8zM405.344 269.648a28.8 28.8 0 0 0 28.8-28.8 56.528 56.528 0 0 1 56.528-56.544h42.656a56.528 56.528 0 0 1 56.544 56.544 28.8 28.8 0 0 0 57.6 0 114.128 114.128 0 0 0-112.64-114.128h-45.648a114.144 114.144 0 0 0-112.64 114.128 28.8 28.8 0 0 0 28.8 28.8z"></path>
                <path d="M163.2 266.672a28.8 28.8 0 0 1 28.8-28.8h640a28.8 28.8 0 0 1 0 57.6H192a28.8 28.8 0 0 1-28.8-28.8zM426.672 371.2a28.8 28.8 0 0 1 28.8 28.8v320a28.8 28.8 0 0 1-57.6 0V400a28.8 28.8 0 0 1 28.8-28.8zM597.344 371.2a28.8 28.8 0 0 1 28.8 28.8v320a28.8 28.8 0 0 1-57.6 0V400a28.8 28.8 0 0 1 28.8-28.8z"></path></svg>
            </div>
         </div> <!--chart-tools-bar-->

              </div>

              <div class="chart-widget">
                <div id="klinedaymain" style="width:100%;height:100%;"> </div>
              </div>
          </div>

      </div> <!-- k-line-chart-light -->
      </div> <!-- boardmain -->
 
      <div class="col-3" style="float:right;margin:10px;">


           <div  class="shadow-sm p-3 mb-5 bg-white rounded" style="overflow-y:scroll;max-height:600px;">
    
            <input class="form-control" type="text" @input="search" v-model="keyword">
            <ul class="dropdown-menu " style="background:#F5F5F5;"> 
                  <template v-for="item in searchlist">
                  <li @click="clickresult(item.code)" style="margin:5px;">{{item.name}} - {{item.code}}</li>
                  </template>
            </ul>

            <h5 style="margin-top:5px;">最近访问</h5>
            <table class="table table-bordered" border="1">
            <thead>
            <tr>
            <th scope="col">name</th>
            <th scope="col">code</th>
            <th scope="col">值
            <th scope="col" v-if="opened">操作</th>
            </tr>
            </thead>
             <tbody>

                <tr v-for="(item,index) in stocktoplist">
                <td v-if="result[item]"><a @click="reloadtop(item)" target=_blank>{{result[item][0]}}</a></td>
                <td v-if="result[item]">

                <i class="fa fa-ban fa-fw" style="margin-right:5px;color:red;" @click="downtop(item)"></i>
                <a v-bind:href="'https://gu.qq.com/'+item" target=_blank ><font color=blue>{{result[item][1]}}</font></a></td>
                <td v-if="result[item]"><font v-if="result[item][2]>=0" color="#ef4136">+{{result[item][2]}}</font> <font v-if="result[item][2]<0" color="#00ef00">{{result[item][2]}}</font></td>
                </tr>

 
                <tr v-for="(item,index) in stockwatcherlist">
                <td v-if="result[item]"><a @click="reloadwatcher(item)" target=_blank>{{result[item][0]}}</a></td>
                <td v-if="result[item]">

                <i class="fa fa-eye-slash" style="margin-right:5px;color:#f47920;" @click="downwatcher(item)"></i>
                <a v-bind:href="'https://gu.qq.com/'+item" target=_blank ><font color=blue>{{result[item][1]}}</font></a></td>
                <td v-if="result[item]"><font v-if="result[item][2]>=0" color="#ef4136">+{{result[item][2]}}</font> <font v-if="result[item][2]<0" color="#00ef00">{{result[item][2]}}</font></td>
                </tr>
 

                <tr v-for="(item,index) in stocklist">
                <td v-if="result[item]"><a @click="reload(item)" target=_blank>{{result[item][0]}}</a>
                </td>
                <td v-if="result[item]">

                <i class="fa fa-hand-o-up" style="margin-right:5px;" @click="uptop(item)"></i>
                <a v-bind:href="'https://gu.qq.com/'+item" target=_blank ><font color=blue>{{result[item][1]}}</font></a>
                <i class="fa fa-eye" style="margin-left:10px;" @click="upwatcher(item)"></i>
                </td>
                <td v-if="result[item]"><font v-if="result[item][2]>=0" color="#ef4136">+{{result[item][2]}}</font> <font v-if="result[item][2]<0" color="#00ef00">{{result[item][2]}}</font></td>
                </td>
                </tr>
                </tbody>
            </table>
       </div>
      </div>

    <div style="z-index: 9999; position:fixed; right: 50px; bottom: 50px;">
    <button class="btn btn-primary" @click="refresh">刷</button>
    <button class="btn btn-primary" @click="display" style="margin-left:5px;">显</button>
    </div>

   </div> <!-- app -->
    <script src="https://lib.baomitu.com/vue/3.2.31/vue.global.js"></script>
    <script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.js"></script>
    <script  src="https://lib.baomitu.com/axios/0.27.2/axios.min.js"></script>

    <!-- Template Main JS File -->
    <script type="text/javascript" src="https://unpkg.com/klinecharts/dist/klinecharts.min.js"></script>
    <script type="text/javascript" src="https://klang.org.cn/js/vendors.min.js"></script>
      <script>
       function getUrlParam(name){

            var reg=new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r= window.location.search.substr(1).match(reg);

            if(r != null) {
                return unescape(r[2]);
            }
            return null;
        }
 


       var hostname = window.location.hostname
       var host = window.location.host
       if (hostname == "" ||hostname == '127.0.0.1'){
            hostname = "127.0.0.1"
            apihost = "http://127.0.0.1:9999"
       } else {
            apihost = "https://api.klang.org.cn"
       }

       //apihost = "https://api.klang.org.cn"

       /****************************store list*****************/

       function getbrowserlist(){
            return getlist('klangbrowserlist')
       }

       function savebrowserlist(code1){
            return savelist('klangbrowserlist',code1)
       }

       function deletebrowserlist(code){
            return deletelist('klangbrowserlist',code)
       }

       function gettoplist(){
            return getlist('klangtoplist')
       }

       function savetoplist(code1){
            return savelist('klangtoplist',code1)
       }

       function deletetoplist(code){
            return deletelist('klangtoplist',code)
       }


       function getwatcherlist(){
            return getlist('klangwatcherlist')
       }

       function savewatcherlist(code1){
            return savelist('klangwatcherlist',code1)
       }

       function deletewatcherlist(code){
            return deletelist('klangwatcherlist',code)
       }



 
       function getlist(name){
         var blist=[]
         blist1 = localStorage.getItem(name)

         if (blist1 != null){
            blist = JSON.parse(blist1)
         }
            
         return blist

       }

     function savelist(name,code1){
         var blist=[]
         blist1 = localStorage.getItem(name)

         if (blist1 != null){
            blist = JSON.parse(blist1)
         }
        i = blist.indexOf(code1) 
        
        if(i >= 0){
            //更换顺序
            blist.splice(i,1)
        }    
        //添加到开头
        blist.unshift(code1)
        localStorage.setItem(name,JSON.stringify(blist.slice(0,100)))
        return blist
    }


    function deletelist(name,code){
         var blist=[]
         blist1 = localStorage.getItem(name)

         if (blist1 != null){
            blist = JSON.parse(blist1)
         }
        
        i = blist.indexOf(code) 
        if (i>=0){
            blist.splice(i,1)
        }
        localStorage.setItem(name,JSON.stringify(blist))
        return blist
 
    }

    /*****************end store list**************/



        /******* 获取股票数据 ***/

          function formatData(code,datas){
            var name = datas[0]
            var close1 = datas[2]
            var close = datas[3]


                        //开盘前价格为零
            if (close == 0){
                close = close1
            } 

            var rise = 100 * (close - close1) / close1
            if (String(parseFloat(rise)) != "NaN"){ //NaN 是无法直接比较的
                rise = parseFloat(rise).toFixed(2)
            } else {
                rise = 0.000
            } 
            close = parseFloat(close).toFixed(2) 
            vue.$data.result[code]=[name,close,rise]
            console.log(name,close,rise)
       }
       

      async function getDatas(that){
        stocklist = that.stocklist.concat(that.stocktoplist)
        stocklist = stocklist.concat(that.stockwatcherlist)

        for (i=0 ; i < stocklist.length;i+=100){
            params = stocklist.slice(i,i+100).join()
            response = await axios.get(apihost+"/?list="+params)

            var hq_str_sys_auth;
 
            eval(response.data)

            // 服务器返回错误，上面的定义就会在eval时候被赋值
            if (hq_str_sys_auth=="FAILED"){
                return
            }
            console.log(response)
        }
        stocklist.forEach(function(item){

                  eval('window.'+item +'= hq_str_'+item)
                  var datas= window[item].split(',')

                  formatData(item,datas)

                })

      }




    var datalinelist = []
    var datadaylist = []
    var loaddata = 0
    var linebar = 255
    var code = getUrlParam('code')
    if (code == null ){
        //中国电建
        code = 'sh601669'
    }

    async function getLineSinaData(code){
        var close1 = ''
        var lclose = 0 //low
        var hclose = 0 //high
        response = await axios.get(apihost+'/cn/api/json_v2.php/CN_MarketDataService.getKLineData?symbol='+code+'&scale=1&ma=no&datalen='+linebar)
    
       //
        data = response.data
        var lastday = new Date(data[data.length-1].day).toDateString()
        var lastday1 = new Date(data[data.length-1].day).toISOString().slice(0,10)
       
        var templist = [] 
        response.data.forEach(function(item){
 
            if (item.day.search('14:57:00') > 0 && item.day.search(lastday1) < 0){
                close1 = parseFloat(item.close)
            }
            //有时候最后一个数据不是15:00:00,而是14:57:00
            if (item.day.search('15:00:00') > 0 && item.day.search(lastday1) < 0){
                close1 = parseFloat(item.close)
            }
            //如果实时数据是今天，则显示
            if(new Date(item.day).toDateString() === lastday){
                c = parseFloat(item.close)
                if (close1 == ''){
                    close1 = c
                }
                if(lclose > c|| lclose==0){
                    lclose = c
                }
                if (hclose < c){
                    hclose = c
                }
                templist.push({
                    open: parseFloat(item.open),
                    close: parseFloat(item.close),
                    high: parseFloat(item.high),
                    low: parseFloat(item.low),
                    volume: parseFloat(item.volume),
                    timestamp:new Date(item.day).getTime(),
                })
            }
        })
        datalinelist = templist
        return [close1,hclose,lclose]
    }

    async function getInfoData(code){

        (async() => {
            let response = null;
            try {
  
                //response = await axios.get(apihost + '/realstock/company/'+ code +'/jsvar.js')
                response = await axios.get(apihost + '/finance?'+ code)
                vue.$data.totalcapital = parseFloat(response.data.zongguben) / 10000 / 10000
                vue.$data.curracapital = parseFloat(response.data.liutongguben) / 10000 / 10000 
                vue.$data.jinglirun = parseFloat(response.data.jinglirun) / 10000 / 10000 / 10 
               } catch (err) {
                    vue.$data.totalcapital = 0
                    vue.$data.curracapital = 0 
               } finally {
                }
            })();

    }

    async function getDaySinaData(code){
        var lastday1=""
        //日K数据结构不包含正在交易的日K数据
        response = await axios.get(apihost+'/cn/api/json_v2.php/CN_MarketDataService.getKLineData?symbol='+code+'&scale=240&ma=no&datalen=500')
        response.data.forEach(function(item){
                if (lastday1 == "") { rise = 0; 
                } else {
                    close1 = parseFloat(item.close).toFixed(2)
                    close2 = lastday1.close
                    rise = (close1 - close2 ) / close2 * 100
                    rise = parseFloat(rise).toFixed(2)
                }
                datadaylist.push({
                    open: parseFloat(item.open),
                    close: parseFloat(item.close),
                    high: parseFloat(item.high),
                    low: parseFloat(item.low),
                    volume: parseFloat(item.volume),
                    timestamp:new Date(item.day).getTime(),
                    rise:rise,
                })
                lastday1 = item
        })
        
        //用实时数据补齐当日的日K
        response1 = await axios.get(apihost+"/?list="+code)
        var lastday = response1.data.split(",")
        if (lastday.length>30){
            ldate = lastday[30]
            close = lastday[3]
            open = lastday[1]
            high = lastday[4]
            low = lastday[5]
            if ( open == 0) {
                high = lastday[2]
                low = lastday[2]
                open = lastday[2]
                close = lastday[2]

            }
            if(ldate !=lastday1.day){
                //如果不包含就补齐
                close2 = parseFloat(lastday1.close).toFixed(2)
                rise = (close - close2 ) / close2 * 100
                rise = parseFloat(rise).toFixed(2)
                datadaylist.push({
                    open:parseFloat(open),
                    close:parseFloat(close),//当前日期的实施数据为当今收盘价
                    high:parseFloat(high),
                    low:parseFloat(low),
                    volume:parseFloat(lastday[8]),
                    timestamp:new Date(ldate).getTime(),
                    rise:rise,
                })
                
            }
        }
        vue.$data.curprice = datadaylist[datadaylist.length-1].close 
    }

    /*************股票数据操作结束***********/
 
    window.onload = async function () {


        const VueApp = {
             data() {
                return {
                opened:0,
                lineorder:'one',
                display_state:1,
                chartline:'',
                chartday:'',
                reloadlock:0,
                result:[],
                stocklist:[],
                stocktoplist:[],
                stockwatcherlist:[],
                keyword:"",
                searchlist:[],
                stockname:"",
                stockcode:"",
                timer:'',
                curprice:"",
                curracapital:"",
                totalcapital:"",
                jinglirun:0,

            }
          },
          watch:{

            async stocklist(){
                await getDatas(this)
                this.stockcode = code
                this.stockname = this.result[code][0]
            },

          }, 
          async created() {
                 this.display_state = localStorage.getItem("display")
                 if (this.display_state == null){
                     this.display_state = "1"
                 }
                 var lineorder = localStorage.getItem("lineorder")
                 if (lineorder == 'one' || lineorder == 'three'){
                    this.lineorder = lineorder
                }

         },

         async mounted () {


            var that = this
            $("#app").css({"opacity":1});

            that.stocktoplist = gettoplist()
            that.stockwatcherlist = getwatcherlist()
            await getDatas(that)

            this.timer = setInterval(this.update, 3000);

            this.stockcode = code
            if (this.result[code]){
                this.stockname = this.result[code][0]
            }
         },
         methods: {
                create_overlay(name){
                    this.chartday.createOverlay({"name":name,"groupId":"overlaydraw"});
                },
                remove_overlay(){
                    this.chartday.removeOverlay({"groupId":"overlaydraw"})
                },
                linedown(){
                    this.lineorder="three"
                    localStorage.setItem("lineorder",this.lineorder)
                },
                lineup(){
                    this.lineorder="one"
                    localStorage.setItem("lineorder",this.lineorder)
                },
                display(){

                    this.display_state = localStorage.getItem("display")
                    if (this.display_state == "0"){
                        this.display_state = "1"
                    } else {
                        this.display_state = "0"
                    }
                    localStorage.setItem("display",this.display_state)
                },

                async update(){


                    getDatas(this)
                    if (loaddata == 1){
                        return
                    }
 
                    datalinelist = []
                     
                    arrayclose1 = await getLineSinaData(code)
                    close1 = arrayclose1[0]
                    hclose = arrayclose1[1]
                    lclose = arrayclose1[2]


                    if(hclose-close1>close1-lclose){
                        lclose = close1 * 2 - hclose
                    } else {
                        hclose = close1 * 2 - lclose
                    }     

                    lclose = lclose * 0.995
                    hclose = hclose * 1.005
                    
                    // linebar 每天的分时线个数 每分钟一个，245个
                    barsize = chartline._chartStore._timeScaleStore._totalBarSpace / (linebar+10)
                
                    // 靠左显示
                    chartline._chartStore._timeScaleStore._barSpace = barsize
                    
                    // 靠左显示
                    this.chartline.setOffsetRightDistance((linebar-datalinelist.length) * barsize)
                    
                    this.chartline.applyNewData(datalinelist)

                    chartline._panes.get("candle_pane").getAxisComponent().setExtremum({min:lclose,
                        max:hclose,
                        range:hclose-lclose,
                        realMax:hclose,
                        realMin:lclose,
                        realRange:hclose-lclose})

                    chartline.adjustPaneViewport(true, true, true, true, true)
 

                },
                async refresh(){
 
                     
                    loaddata = 1
 
                    datadaylist = []
                    datalinelist = []

                    await getDaySinaData(code)

                    await getInfoData(code)

                    this.chartday.applyNewData(datadaylist)
 
                    //获取昨天的收盘价
                    arrayclose1 = await getLineSinaData(code)
                    close1 = arrayclose1[0]
                    hclose = arrayclose1[1]
                    lclose = arrayclose1[2]


                    if(hclose-close1>close1-lclose){
                        lclose = close1 * 2 - hclose
                    } else {
                        hclose = close1 * 2 - lclose
                    }     

                    lclose = lclose * 0.995
                    hclose = hclose * 1.005

                    chartline.removeOverlay({"name":"simpleTag"})

                    chartline.createOverlay({

                            name:"simpleTag",
                            extendData:"close:" + close1,
                            styles: { text: { color: '#98cc12' } ,color: 'rgba(230, 230, 100, .3)',style:'dashed' },
                            points: [{ value: close1 }],

                        })

                    // linebar 每天的分时线个数 每分钟一个，245个
                    barsize = chartline._chartStore._timeScaleStore._totalBarSpace / (linebar+10)
                
                    // 靠左显示
                    chartline._chartStore._timeScaleStore._barSpace = barsize
                    
                    // 靠左显示
                    this.chartline.setOffsetRightDistance((linebar-datalinelist.length) * barsize)
                    
                    this.chartline.applyNewData(datalinelist)

                    chartline._panes.get("candle_pane").getAxisComponent().setExtremum({min:lclose,
                        max:hclose,
                        range:hclose-lclose,
                        realMax:hclose,
                        realMin:lclose,
                        realRange:hclose-lclose})

                    chartline.adjustPaneViewport(true, true, true, true, true)

                   
 
                    getDatas(this)


                    this.stockcode = code
                    this.stockname = this.result[code][0]
                    loaddata = 0

                } ,//refresh
                async reloadtop(newcode){
                    if (this.reloadlock == 1){
                        return
                    }
                    this.reloadlock = 1
                    code = newcode
                    this.stocklist = getbrowserlist( )
                    this.stocktoplist = savetoplist(code)

                    await this.refresh()
                    this.reloadlock = 0
                },
                async reloadwatcher(newcode){
                    if (this.reloadlock == 1){
                        return
                    }
                    this.reloadlock = 1
                    code = newcode
                    this.stocklist = getbrowserlist( )
                    this.stockwatcherlist = savewatcherlist(code)

                    await this.refresh()
                    this.reloadlock = 0
                },
 
 
                async uptop(code){
                     deletebrowserlist(code)
                     this.reloadtop(code)
                },
                async upwatcher(code){
                     deletebrowserlist(code)
                     this.reloadwatcher(code)
                },
                async downtop(code){
                     deletetoplist(code)
                     this.reload(code)
                },
                async downwatcher(code){
                     deletewatcherlist(code)
                     this.reload(code)
                },
                async reload(newcode){
                    if (this.reloadlock == 1){
                        return
                    }
                    this.reloadlock = 1
                    code = newcode
                    this.stocklist = savebrowserlist(code)
                    this.stocktoplist = gettoplist()
                    this.stockwatcherlist = getwatcherlist()

                    await this.refresh()
                    this.reloadlock = 0
                },
                async search(){
                    var that = this
                    t = new Date().getTime()
                    var recode = new RegExp(/(sh~\d{6})~(.*?)~|(sz~\d{6})~(.*?)~/,"g")
                    response = await axios.get(apihost+"/s3/?v=2&q="+that.keyword+"&t=all&_=" + t)
                    eval(response.data)
                    result = v_hint.match(recode)
                    searchlist = []
                    
                    result.forEach(function(item){
                        datas = item.split("~")
                        name = datas[2].toLocaleString()
                        searchlist.push({code:datas[0]+datas[1],name:name})
                    })
                    that.searchlist = searchlist
                    
                    console.log(searchlist)

                    $(".dropdown-menu").show()
                },
                async clickresult(code){
                    this.keyword=""
                    this.reload(code)
                    $(".dropdown-menu").hide()
                }
         } //methods
        }

        window.vue = Vue.createApp(VueApp).mount('#app')

        /*************股票K线显示******/

        
 
         var chartline = klinecharts.init('klinelinemain')
         var chartday = klinecharts.init('klinedaymain')


          window.chartday = chartday
          window.vue.$data.chartday = chartday
          window.vue.$data.chartline = chartline

        // 创建一个副图技术指标VOL
         chartline.createIndicator("VOL")



        window.chartline = chartline
        
        chartline.setStyles({
            candle:{
                type:"area",
                area: {
                    lineSize: 2,
                    lineColor: '#2196F3',
                    value: 'close',
                    backgroundColor: [{
                        offset: 0,
                        color: 'rgba(33, 150, 243, 0.01)'
                    }, {
                        offset: 1,
                        color: 'rgba(33, 150, 243, 0.2)'
                    }]
                }
            },
            
         indicator: {
            ohlc: {
            downColor: 'rgba(38, 166, 154, .65)',
            upColor: 'rgba(239, 83, 80, .65)',
            noChangeColor: '#888888'
            },
            bars: [{
            // 'fill' | 'stroke' | 'stroke_fill'
            style: 'fill',
            // 'solid' | 'dashed'
            borderStyle: 'solid',
            borderSize: 1,
            borderDashedValue: [2, 2],
            downColor: 'rgba(38, 166, 154, .65)',
            upColor: 'rgba(239, 83, 80, .65)',
            noChangeColor: '#888888'
            }]

            }
        })


        loaddata = 1
        //获取昨天的收盘价
        arrayclose1 = await getLineSinaData(code)
        close1 = arrayclose1[0]
        hclose = arrayclose1[1]
        lclose = arrayclose1[2]


        if(hclose-close1>close1-lclose){
            lclose = close1 * 2 - hclose
        } else {
            hclose = close1 * 2 - lclose
        }      

        lclose = lclose * 0.995
        hclose = hclose * 1.005


         chartline.createOverlay(
          {

            name:"simpleTag",
            extendData:"close:" + close1,
            styles: { text: { color: '#98cc12' } ,color: 'rgba(230, 230, 100, .3)',style:'dashed' },
            points: [{ value: close1 }],

          }
         )




        // linebar 每天的分时线个数 每分钟一个，245个
        barsize = chartline._chartStore._timeScaleStore._totalBarSpace / (linebar+10)
      
        // 靠左显示
        chartline._chartStore._timeScaleStore._barSpace = barsize
        chartline.setOffsetRightDistance((linebar-datalinelist.length) * barsize) 
         

        chartline.applyNewData(datalinelist)

        chartline._panes.get("candle_pane").getAxisComponent().setExtremum({min:lclose,
                        max:hclose,
                        range:hclose-lclose,
                        realMax:hclose,
                        realMin:lclose,
                        realRange:hclose-lclose})

        chartline.adjustPaneViewport(true, true, true, true, true)


        if (datalinelist.length>0){

            vue.$data.stocklist = savebrowserlist(code)
        }



        chartday.createIndicator('MA', false, { id: 'candle_pane' })
        // 创建一个副图技术指标VOL
        chartday.createIndicator("VOL")
    
        // 创建一个副图技术指标MACD
        chartday.createIndicator('MACD')
        chartday.setStyles({

            indicator: {
                ohlc: {
                downColor: 'rgba(38, 166, 154, .65)',
                upColor: 'rgba(239, 83, 80, .65)',
                noChangeColor: '#888888'
                },
                bars: [{
                // 'fill' | 'stroke' | 'stroke_fill'
                style: 'fill',
                // 'solid' | 'dashed'
                borderStyle: 'solid',
                borderSize: 1,
                borderDashedValue: [2, 2],
                downColor: 'rgba(38, 166, 154, .65)',
                upColor: 'rgba(239, 83, 80, .65)',
                noChangeColor: '#888888'
                }]
            
            },
      })


        function handle_day( kLineData, candleOptions){
            data = kLineData.current

             
            color = data.rise > 0 ? '#EF5350' : '#26A69A'
            d = new Date(data.timestamp).toLocaleString().split(" ")[0].replaceAll("/","-")
            return [{title:"时间: ",value:d},
                    {title:"开: ",value:data.open },
                    {title:"收: ",value:data.close},
                    {title:"高: ",value:data.high},
                    {title:"低: ",value:data.low},
                    {title:"成交量: ",value:data.volume},
                    {title:"涨幅: ",value:{"text":data.rise,"color":color}},

            ]

        }
       chartday.setStyles({
        candle: {
          tooltip: {
            custom:handle_day  
          },
          bar: {
           downColor: '#26A69A',
           upColor: '#EF5350',
           noChangeColor: '#888888',
           downBorderColor: '#26A69A',
           upBorderColor: '#EF5350',
           downWickColor: '#26A69A',
           upWickColor: '#EF5350'                   
          }
         },

      })
        await getDaySinaData(code)
        await getInfoData(code)
 
        chartday.applyNewData(datadaylist)

        loaddata = 0


        window.addEventListener("resize",function(){
            chartday.adjustPaneViewport(true, true, true, true, true)

            //重新计算 chartline 的每个bar宽度
            // linebar 每天的分时线个数 每分钟一个，245个
            barsize = chartline._chartStore._timeScaleStore._totalBarSpace / (linebar+10)
        
            // 靠左显示
            chartline._chartStore._timeScaleStore._barSpace = barsize
            chartline.setOffsetRightDistance((linebar-datalinelist.length) * barsize) 
            extremum = chartline._panes.get("candle_pane").getAxisComponent().getExtremum()
            extremum.min = lclose;
            extremum.max = hclose;
            chartline._panes.get("candle_pane").getAxisComponent().setExtremum(extremum)

            chartline.adjustPaneViewport(true, true, true, true, true)

        })
    }
      
 
   </script>

    </body>
</html>
